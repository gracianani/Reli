@model ReliDemo.ViewModels.DailyReportViewModel
@{
    ViewBag.Title = "PreviewDaily";

    Layout = "~/Views/Shared/_Layout.cshtml";
}

<a href="/Reports/Index" class="btn btn-primary">返回</a>
<h2 style='font-family: "Microsoft Yahei",sans-serif;
font-size: 24px;
margin-bottom: 0.9em;
line-height: 30px;'>
    @Model.Title<span style="font-size:14px">@Model.From.ToString("yyyy年MM月dd日") - @Model.To.ToString("yyyy年MM月dd日")</span>
</h2>
<div class="row-fluid">
    <div class="input-prepend date">
        <span class="add-on"><i class="icon-calendar"></i></span>
        <input type="text" class="form-control date-picker input-small" id="report-date" name="date" data-date-format="yyyy-mm-dd" value=@Model.From.ToString("yyyy-MM-dd") data-provide="datepicker-inline" />
        <input type="text" class="form-control date-picker input-small" id="report-dateTo" name="date" data-date-format="yyyy-mm-dd" value=@Model.To.ToString("yyyy-MM-dd") data-provide="datepicker-inline" />
        
    </div>
    <a id="preview" href="javascript:void(0)" class="btn btn-primary" data-reporttype="@Model.ReportTypeId">预览</a>
    <a id="download" href="javascript:void(0)" class="btn btn-primary" data-reporttype="@Model.ReportTypeId">下载</a>

    <div id="validationErrorReport" class="alert alert-error hidden inline" style="display:inline">请填写“时间”。</div>
</div>
<div class="scrollableTableContainer">
    @{
        <table class="table  table-bordered table-hover  table-condensed table-clickhighlight datatable" style="background:white">
            <tr>
                <th rowspan="2">日期</th>
                <th rowspan="2">室外温度(℃)</th>
                <th colspan="5">执行到位率(%)</th>
                <th colspan="5">超标站总面积(万㎡)</th>
                <th colspan="5">有效站总面积(万㎡)</th>
                <th colspan="5">有效站数(个)</th>
                
            </tr>
            <tr>
                <th>销售</th>
                <th>创合</th>
                <th>特力昆</th>
                <th>天禹</th>
                <th>合计</th>

                <th>销售</th>
                <th>创合</th>
                <th>特力昆</th>
                <th>天禹</th>
                <th>合计</th>

                <th>销售</th>
                <th>创合</th>
                <th>特力昆</th>
                <th>天禹</th>
                <th>合计</th>

                <th>销售</th>
                <th>创合</th>
                <th>特力昆</th>
                <th>天禹</th>
                <th>合计</th>
            </tr>
            @foreach (var item in Model.ReportData)
            {
                <tr class=@if (!item.日期.HasValue || !item.室外温度.HasValue)
                { <text> alert-danger </text>  }>
                    <td>
                        @if (item.日期.HasValue)
                        {
                            <text> @item.日期.Value.ToString("MM月dd日") </text>
                        }
                        else
                        {
                            <text> -- </text>
                        }
                    </td>
                    <td>@item.GetDisplay(item.室外温度, "℃")</td>
                    <td>@item.GetDisplay(item.销售执行到位率, "%")</td>
                    <td>@item.GetDisplay(item.创合执行到位率, "%")</td>
                    <td>@item.GetDisplay(item.特力昆执行到位率, "%")</td>
                    <td>@item.GetDisplay(item.天禹执行到位率, "%")</td>
                    <td>@item.GetDisplay(item.合计执行到位率, "%")</td>

                    <td>@item.GetDisplay(item.销售超标站总面积) </td>
                    <td>@item.GetDisplay(item.创合超标站总面积) </td>
                    <td>@item.GetDisplay(item.特力昆超标站总面积) </td>
                    <td>@item.GetDisplay(item.天禹超标站总面积)  </td>
                    <td>@item.GetDisplay(item.合计超标站总面积) </td>

                    <td>@item.GetDisplay(item.销售有效站总面积) </td>
                    <td>@item.GetDisplay(item.创合有效站总面积) </td>
                    <td>@item.GetDisplay(item.特力昆有效站总面积) </td>
                    <td>@item.GetDisplay(item.天禹有效站总面积) </td>
                    <td>@item.GetDisplay(item.合计有效站总面积) </td>

                    <td>@item.GetDisplay(item.销售有效站数) </td>
                    <td>@item.GetDisplay(item.创合有效站数) </td>
                    <td>@item.GetDisplay(item.特力昆有效站数) </td>
                    <td>@item.GetDisplay(item.天禹有效站数) </td>
                    <td>@item.GetDisplay(item.合计有效站数) </td>
                </tr>
            }
        </table>
    }
</div>


<script>
    $(function () {

        $('#download').click(function (e) {
            var url = 'DownloadRangeReport?' +
                'reportType=' + $(this).attr("data-reportType") +
                '&fromDate=' + $("#report-date").val() +
                '&toDate=' + $("#report-dateTo").val();
            if (!$("#report-date").val() ) {
                if ($("#validationErrorReport").hasClass("hidden")) {
                    $("#validationErrorReport").removeClass("hidden");
                }
                return;
            }
            else {
                $("#validationErrorReport").addClass("hidden");
            }
            var self = this;
            if ($(this).hasClass("disabled")) {
                return;
            }

            $.ajax({
                url: url,
                beforeSend: function () {
                    $(self).html("正在生成报表...").addClass("disabled");
                },
                success: function (i) {
                    window.location = i.fileName;

                },
                error : function(i)
                {
                    $(self).html("生成报表出错");
                    setTimeout("$(self).html('下载');", 3000);
                },
                complete: function() {
                    $(self).html('下载').removeClass("disabled");;
                }
            })
        ;
        });

        $('#preview').click(
            function () {
                var url = '/Reports/PreviewDaily?' +
                'reportType=' + $(this).attr("data-reporttype") +
                '&dateFrom=' + $("#report-date").val() +
                '&dateTo=' + $('#report-todate').val();
                if (!$("#report-date").val() || !$("#report-todate").val()) {
                    if ($("#validationErrorReport").hasClass("hidden")) {
                        $("#validationErrorReport").removeClass("hidden");
                    }
                    return;
                }
                else {
                    $("#validationErrorReport").addClass("hidden");
                }
                var self = this;
                if ($(this).hasClass("disabled")) {
                    return;
                }
                window.location.href = url;
            }
        );
    });
</script>